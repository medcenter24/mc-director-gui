<!--
  ~ Copyright (c) 2017.
  ~
  ~ @author Alexander Zagovorichev <zagovorichev@gmail.com>
  -->

<div *ngIf="accident" class="case-editor">
    <div class="row">
        <div class="col-sm-12 form-block">
            <ba-card baCardClass="with-scroll">
            <form class="form" (ngSubmit)="onSubmit()" #accidentForm="ngForm">
                <div class="form-group">
                    <div class="row">
                        <div class="col-sm-6">
                            <h3 *ngIf="accident.id">{{ 'general.editing_case' | translate}} {{ 'general.pp' | translate }}{{ accident.id }}</h3>
                            <h3 *ngIf="!accident.id">{{ 'general.creating_new_case' | translate }}</h3>
                        </div>
                        <div class="col-sm-6">
                            <b class="text-muted offset-right10 pull-left">{{ 'general.referral_number' | translate }}</b>
                            <p-inplace closable="true" class="pull-left">
                                <span pInplaceDisplay>
                                    {{ accident.ref_num }}
                                </span>
                                <span pInplaceContent>
                                    <input type="text" value="{{ accident.ref_num }}" (change)="onReferralChanged($event)" pInputText placeholder="{{ 'general.referral_number' | translate }}">
                                </span>
                            </p-inplace>
                            <b pTooltip="{{ 'general.referral_rule' | translate }}" class="pull-left badge badge-default">?</b>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="row">
                        <div class="col-sm-6">
                            <b class="text-muted offset-right10">{{ 'general.applied_time' | translate }}</b>
                            <p-calendar
                                    name="appliedTime"
                                    [(ngModel)]="appliedTime"
                                    [maxDate]="maxDate"
                                    [showTime]="true"
                                    [hourFormat]="24"
                                    [required]="true"
                            ></p-calendar>
                        </div>
                        <div class="col-sm-6">
                            <b class="text-muted offset-right10">{{ 'general.accident_type' | translate }}</b>
                            <select-accident-type
                                    [selectedTypeId]="accident.accident_type_id"
                                    (selected)="onAccidentTypeSelected($event)"
                            ></select-accident-type>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="row">
                        <div class="col-sm-12">
                            <services-selector
                                    [caseId]="accident.id"
                                    (priceChanged)="onServicesSelectorPriceChanged($event)"
                            ></services-selector>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="row">
                                <div class="col-sm-12 col-md-6 col-lg-3">
                                    <b class="text-muted">{{ 'general.assistant' | translate }}</b>
                                    <br><select-assistant
                                            [assistantId]="accident.assistant_id"
                                            (change)="onAssistantChanged($event)"
                                        ></select-assistant>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-3">
                                    <b class="text-muted">{{ 'general.discount_type' | translate }}</b>
                                    <br>
                                    <select-accident-discount-type
                                            [selectedDiscountId]="accident.discount_type_id"
                                            (selected)="onDiscountTypeSelected($event)"
                                    ></select-accident-discount-type>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-3">
                                    <b class="text-muted">{{ 'general.discount_value' | translate }}</b><br>
                                    <p-spinner size="30"
                                               [min]="0"
                                               [(ngModel)]="discountValue"
                                               name="discountValue"
                                               (onChange)="onDiscountValueChanged()"></p-spinner>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-3">
                                    <b class="text-muted">{{ 'general.total_score' | translate }}</b>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="well well-lg bg-warning">{{ 'general.total_amount' | translate }}: {{ totalAmount }}</div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="well bg-success" pTooltip="{{ 'general.formula' | translate }}: {{ totalIncomeFormula }}">
                                                <b>{{ 'general.total_income' | translate }}</b>: {{ totalIncome }}
                                                <b class="pull-right badge badge-default">?</b>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row offset-bottom20">
                                <div class="col-sm-6">
                                    <div class="row offset-bottom20">
                                        <div class="col-sm-6">
                                            <b class="text-muted">{{ 'general.patient_name' | translate }}</b>
                                            <br>
                                            <input *ngIf="patient" type="text" pInputText [value]="patient.name" placeholder="{{ 'general.patient_name' | translate }}"/>
                                        </div>
                                        <div class="col-sm-6">
                                            <b class="text-muted">{{ 'general.patient_phone' | translate }}</b>
                                            <br>
                                            <input *ngIf="patient" type="text" pInputText [value]="patient.phones" placeholder="{{ 'general.patient_phone' | translate }}"/>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <b class="text-muted">{{ 'general.symptoms' | translate }}</b>
                                            <br>
                                            <textarea rows="5" cols="70" pInputTextarea autoResize="autoResize" placeholder="{{ 'general.symptoms' | translate }}">{{ accident.symptoms }}</textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <b class="text-muted">{{ 'general.repeated_appointment' | translate }}</b>
                                    <div class="row offset-bottom10">
                                        <div class="col-sm-12">
                                            <select-accident
                                                    #parentSelector
                                                    [selectedAccidentId]="accident.parent_id"
                                                    (selected)="onAccidentSelected($event)"
                                            ></select-accident>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <accident-card
                                                    *ngIf="accident.parent_id"
                                                    [(selectedAccidentId)]="accident.parent_id"
                                                    (closed)="onParentDeleted()"
                                            ></accident-card>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row offset-bottom20">
                                <div class="col-sm-5">
                                    <b class="text-muted">{{ 'general.choose_case' | translate }}</b>
                                    <br><select-case-type [selectedCaseTypeId]="accident.caseable_type" (selected)="onCaseTypeSelected($event)"></select-case-type>
                                </div>
                                <div class="col-sm-7">
                                    <div *ngIf="accident.caseable_type === 'App/Doctor'">
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <b class="text-muted">{{ 'general.doctor_case' | translate }}</b>
                                                <br><select-doctor></select-doctor>
                                            </div>
                                            <div class="col-sm-6">
                                                <b class="text-muted">{{ 'general.city' | translate }}</b>
                                                <br><select-city></select-city>
                                            </div>
                                        </div>
                                    </div>
                                    <div *ngIf="accident.caseable_type === 'App/Hospital'">
                                        <b class="text-muted">{{ 'general.hospital_case' | translate }}</b>
                                        <br><select-hospital></select-hospital>
                                    </div>
                                </div>
                            </div>

                            <div class="row offset-bottom20">
                                <div class="col-sm-9">
                                    <b class="text-muted">{{ 'general.commentary' | translate }}</b>
                                    <br><textarea class="form-control" pInputTextarea autoResize="autoResize"></textarea>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-sm-9">
                                    <b class="text-muted">{{ 'general.accident_files' | translate }}</b>
                                    <br>
                                    <file-uploader></file-uploader>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <button pButton type="button" class="ui-button-success" (click)="onSave($event)"
                        [disabled]="!accidentForm.form.valid" label="{{ 'general.save' | translate }}"></button>
            </form>
            </ba-card>
        </div>
    </div>
</div>
