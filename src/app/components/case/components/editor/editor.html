<!--
  ~ Copyright (c) 2017.
  ~
  ~ @author Alexander Zagovorichev <zagovorichev@gmail.com>
  -->
<p-blockUI [blocked]="blocked"></p-blockUI>

<div *ngIf="accident && isLoaded" class="case-editor">
    <div class="row">
        <div class="col-sm-12 form-block">
            <ba-card baCardClass="with-scroll">
            <form class="form" (ngSubmit)="onSubmit()" #accidentForm="ngForm">

                <div class="form-group offset-bottom20">
                    <div class="row">
                        <div class="col-sm-6">
                            <h3 *ngIf="accident.id">{{ 'Case Editing' | translate}} {{ 'pp' | translate }}{{ accident.id }}</h3>
                            <h3 *ngIf="!accident.id">{{ 'New case creating' | translate }}</h3>
                        </div>
                        <div class="col-sm-6">
                            <b class="text-muted offset-right10 pull-left" translate>Referral Number</b>
                            <p-inplace closable="true" class="pull-left">
                                <span pInplaceDisplay>
                                    {{ accident.ref_num }}
                                </span>
                                <span pInplaceContent>
                                    <input type="text" value="{{ accident.ref_num }}" (change)="onReferralChanged($event)" pInputText placeholder="{{ 'Referral Number' | translate }}">
                                </span>
                            </p-inplace>
                            <b pTooltip="{{ 'If you leave it empty then it will be generated automatically' | translate }}" class="pull-left badge badge-default">?</b>
                        </div>
                    </div>
                </div>

                <div class="form-group offset-bottom20">
                    <div class="row offset-bottom20">
                        <div class="col-sm-5">
                            <b class="text-muted">{{ 'Choose Case' | translate }}</b>
                            <br>
                            <select-case-type
                                    *ngIf="!accident.id"
                                    [selectedCaseTypeId]="accident.caseable_type"
                                    (selected)="onCaseTypeSelected($event)"
                            ></select-case-type>

                            <h4 *ngIf="accident.id && accident.caseable_type === 'App\\DoctorAccident'" class="text-danger" translate>
                                Doctor Case
                            </h4>
                            <h4 *ngIf="accident.id && accident.caseable_type === 'App\\HospitalAccident'" class="text-danger" translate>
                                Hospital Case
                            </h4>
                        </div>
                        <div class="col-sm-7">
                            <div *ngIf="accident.caseable_type === 'App\\DoctorAccident'">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <b class="text-muted" translate>Doctor</b>
                                        <br>
                                        <select-doctor
                                                *ngIf="doctorAccident"
                                                [doctorId]="doctorAccident.doctor_id"
                                                (selected)="onDoctorChanged($event)"
                                        ></select-doctor>
                                    </div>
                                    <div class="col-sm-6">
                                        <b class="text-muted" translate>City</b>
                                        <br><select-city
                                                *ngIf="doctorAccident"
                                                [cityId]="doctorAccident.city_id"
                                                (selected)="onCityChanged($event)"
                                            ></select-city>
                                    </div>
                                </div>
                            </div>
                            <div *ngIf="accident.caseable_type === 'App\\HospitalAccident'">
                                <b class="text-muted" translate>Hospital_case</b>
                                <br>
                                <select-hospital
                                        *ngIf="hospitalAccident"
                                        [hospitalId]="hospitalAccident.hospital_id"
                                ></select-hospital>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group offset-bottom20">
                    <div class="row">
                        <div class="col-sm-12">
                            <services-selector
                                    [caseId]="accident.id"
                                    (priceChanged)="onServicesSelectorPriceChanged($event)"
                                    (changedServices)="onServicesChanged($event)"
                            ></services-selector>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="row">
                                <div class="col-sm-12 col-md-6 col-lg-3">
                                    <b class="text-muted" translate>Assistant</b>
                                    <br><select-assistant
                                            [assistantId]="accident.assistant_id"
                                            (change)="onAssistantChanged($event)"
                                        ></select-assistant>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-3">
                                    <b class="text-muted" translate>Discount Type</b>
                                    <br>
                                    <select-discount-type
                                            [selectedDiscountId]="accident.discount_type_id"
                                            (selected)="onDiscountTypeSelected($event)"
                                    ></select-discount-type>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-3">
                                    <b class="text-muted" translate>Discount Value</b><br>
                                    <p-spinner size="30"
                                               [min]="0"
                                               [(ngModel)]="discountValue"
                                               name="discountValue"
                                               (onChange)="onDiscountValueChanged()"></p-spinner>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-3">
                                    <b class="text-muted" translate>Total Score</b>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="well well-lg bg-warning" translate>Total Amount: {{ totalAmount | number }}</div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="well bg-success" pTooltip="{{ 'Formula' | translate }}: {{ totalIncomeFormula }}">
                                                <b translate>Total Income</b>: {{ totalIncome | number }}
                                                <b class="pull-right badge badge-default">?</b>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row offset-bottom20">
                                <div class="col-sm-6">
                                    <div class="row offset-bottom20" *ngIf="patient">
                                        <div class="col-sm-6">
                                            <b class="text-muted" translate>Patient Name</b>
                                            <br>
                                            <input type="text" pInputText [value]="patient.name" placeholder="{{ 'Patient Name' | translate }}"/>
                                        </div>
                                        <div class="col-sm-6">
                                            <b class="text-muted" translate>Patient Phone</b>
                                            <br>
                                            <input type="text" pInputText [value]="patient.phones" placeholder="{{ 'Patient Phone' | translate }}"/>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <b class="text-muted" translate>Symptoms</b>
                                            <br>
                                            <textarea rows="5" cols="70" pInputTextarea autoResize="autoResize" placeholder="{{ 'Symptoms' | translate }}">{{ accident.symptoms }}</textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <b class="text-muted" translate>Repeated Appointment</b>
                                    <div class="row offset-bottom10">
                                        <div class="col-sm-12">
                                            <select-accident
                                                    #parentSelector
                                                    [selectedAccidentId]="accident.parent_id"
                                                    (selected)="onAccidentSelected($event)"
                                            ></select-accident>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <accident-card
                                                    *ngIf="accident.parent_id"
                                                    [(selectedAccidentId)]="accident.parent_id"
                                                    (closed)="onParentDeleted()"
                                            ></accident-card>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group offset-bottom20">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <b class="text-muted offset-right10" translate>Applied Time</b>
                                        <p-calendar
                                                name="appliedTime"
                                                [(ngModel)]="appliedTime"
                                                [maxDate]="maxDate"
                                                dateFormat="dd.mm.yy"
                                                [showTime]="true"
                                                [hourFormat]="24"
                                                [required]="true"
                                        ></p-calendar>
                                    </div>
                                    <div class="col-sm-6">
                                        <b class="text-muted offset-right10" translate>Accident Type</b>
                                        <select-accident-type
                                                [selectedTypeId]="accident.accident_type_id"
                                                (selected)="onAccidentTypeSelected($event)"
                                        ></select-accident-type>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group offset-bottom20">
                                <div class="row">
                                    <div class="col-sm-12">
                                        <diagnostics-selector
                                                [caseId]="accident.id"
                                                (changed)="onDiagnosticsChanged($event)"
                                        ></diagnostics-selector>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-sm-9">
                                    <b class="text-muted" translate>Documents</b>
                                    <br>
                                    <file-uploader
                                            [uploads]="documents"
                                            [url]="caseService.getDocumentsUrl(accident.id)"
                                            (changed)="onDocumentsChanged($event)"
                                    ></file-uploader>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <button pButton type="button" class="ui-button-success" (click)="onSave($event)"
                        [disabled]="!accidentForm.form.valid" label="{{ 'Save' | translate }}"></button>
            </form>
            </ba-card>
        </div>
    </div>
</div>
